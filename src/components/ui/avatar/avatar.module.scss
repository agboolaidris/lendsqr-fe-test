import { render, screen, fireEvent } from "@testing-library/react";
import { describe, it, expect, vi } from "vitest";
import { Avatar } from "./Avatar";

/**
 * Mock next/image to normal img for tests
 */
vi.mock("next/image", () => ({
  default: (props: any) => <img {...props} />,
}));

/**
 * Mock SCSS module classes so they are not hashed
 */
vi.mock("./Avatar.module.scss", () => ({
  default: new Proxy({}, { get: (_, key) => key }),
}));

describe("Avatar", () => {
  it("renders fallback initials when no src is provided", () => {
    render(<Avatar alt="Agboola Idris" />);

    expect(screen.getByText("AI")).toBeInTheDocument();
  });

  it("renders single initial for one-word alt", () => {
    render(<Avatar alt="Idris" />);

    expect(screen.getByText("I")).toBeInTheDocument();
  });

  it("renders default U when alt is empty", () => {
    render(<Avatar alt="" />);

    expect(screen.getByText("U")).toBeInTheDocument();
  });

  it("renders image when src is provided", () => {
    render(<Avatar src="/avatar.png" alt="User Test" />);

    const img = screen.getByAltText("User Test");
    expect(img).toBeInTheDocument();
    expect(img.tagName).toBe("IMG");
  });

  it("falls back to initials when image errors", () => {
    render(<Avatar src="/bad.png" alt="User Test" />);

    const img = screen.getByAltText("User Test");
    fireEvent.error(img);

    expect(screen.getByText("UT")).toBeInTheDocument();
  });

  it("applies interactive role and tabIndex when interactive", () => {
    render(<Avatar alt="User Test" interactive />);

    const avatar = screen.getByRole("button");
    expect(avatar).toHaveAttribute("tabIndex", "0");
  });

  it("uses img role when not interactive", () => {
    render(<Avatar alt="User Test" />);

    const avatar = screen.getByRole("img");
    expect(avatar).toBeInTheDocument();
  });

  it("applies bordered class when bordered prop is true", () => {
    const { container } = render(<Avatar alt="User Test" bordered />);

    expect(container.firstChild).toHaveClass("avatarBordered");
  });

  it("applies interactive class when interactive prop is true", () => {
    const { container } = render(<Avatar alt="User Test" interactive />);

    expect(container.firstChild).toHaveClass("avatarInteractive");
  });

  it("applies correct size class", () => {
    const { container } = render(<Avatar alt="User Test" size="xl" />);

    expect(container.firstChild).toHaveClass("avatar--xl");
  });

  it("applies correct shape class", () => {
    const { container } = render(<Avatar alt="User Test" shape="square" />);

    expect(container.firstChild).toHaveClass("avatar--square");
  });

  it("passes extra HTML props to root div", () => {
    render(<Avatar alt="User Test" data-testid="avatar-root" />);

    expect(screen.getByTestId("avatar-root")).toBeInTheDocument();
  });

  it("negative: should not render image when src is missing", () => {
    render(<Avatar alt="User Test" />);

    const img = screen.queryByRole("img", { hidden: true });
    expect(img).not.toHaveAttribute("src");
  });
});
